<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buddyz — Community (Flexible)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- IonIcons for modern icons -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <style>
    :root{
      --bg:#0f1113;
      --card:#121416;
      --muted:#9aa0a6;
      --accent:#ff2d2d; /* Buddyz red */
      --glass: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:var(--bg);color:#eee;margin:0;min-height:100vh}
    .app{max-width:980px;margin:20px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header h1{font-size:20px;margin:0}
    .small{font-size:12px;color:var(--muted)}

    /* Stories carousel */
    .stories-container {margin-bottom: 20px;}
    .stories-container h2 {font-size: 18px;margin-bottom: 12px;color: #eee;}
    .stories{display:flex;overflow-x:auto;padding:8px 2px;gap:12px;scrollbar-width:none;}
    .stories::-webkit-scrollbar{display:none}
    .story{min-width:130px;display:flex;flex-direction:column;align-items:center;text-align:center;cursor:pointer;transition:transform .2s ease,opacity .2s ease}
    .story:hover{transform:scale(1.05);opacity:.95}
    .story .avatar{width:110px;height:110px;border-radius:22px;background:linear-gradient(180deg,#222,#111);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.05);overflow:hidden;position:relative}
    .story .avatar img{width:100%;height:100%;object-fit:cover}
    .story small{display:block;margin-top:6px;color:var(--muted);font-size:12px;max-width:100%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}

    /* Feed (optional, kept hidden) */
    .feed{display:none}

    /* Composer modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1000}
    .modal.open{display:flex}
    .composer{width:92vw;max-width:520px;background:var(--card);padding:20px;border-radius:16px;box-shadow:0 12px 24px rgba(0,0,0,.8);border:1px solid var(--glass)}
    .composer textarea,.composer input[type="text"]{width:100%;background:transparent;border:1px solid rgba(255,255,255,.08);color:#eee;padding:10px;border-radius:10px;resize:none}
    .composer textarea:focus,.composer input[type="text"]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,45,45,.25)}
    .row{display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,.06);padding:6px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.08)}

    label.btn{display:inline-flex;gap:6px;align-items:center}
    label.btn input{display:none}

    /* Snackbar */
    .message-box{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:12px 18px;border-radius:10px;z-index:2000;opacity:0;transition:opacity .25s ease}
    .message-box.show{opacity:1}

    /* Viewer */
    .viewer-modal{position:fixed;inset:0;display:none;background:#000;z-index:1200;padding:0;flex-direction:column;justify-content:space-between}
    .viewer-modal.open{display:flex}
    .viewer-content{flex-grow:1;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;padding:20px}
    /* Bigger, flexible preview */
    .viewer-content img,.viewer-content .text-post-content{max-width:96%;max-height:88vh;object-fit:contain;border-radius:14px}

    .viewer-header{position:absolute;top:20px;left:20px;right:20px;display:flex;align-items:center;gap:10px;color:#fff}
    .viewer-header .name{font-weight:700}
    .viewer-header .time{color:var(--muted)}

    .viewer-footer{position:absolute;bottom:20px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;row-gap:14px}
    .viewer-footer .btn-group{display:flex;gap:12px;align-items:center}
    /* Optional vertical layout: add .vertical to .viewer-footer */
    .viewer-footer.vertical{flex-direction:column;align-items:flex-start}

    .btn{background:rgba(255,255,255,.12);border:none;color:#fff;padding:8px;border-radius:50%;width:44px;height:44px;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:background .2s ease,transform .2s ease,opacity .2s ease}
    .btn:hover{background:rgba(255,255,255,.2);transform:scale(1.06)}
    .btn:active{transform:scale(.95)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn ion-icon{font-size:24px}
    .like-btn.liked ion-icon{color:var(--accent)}

    .text-post-content{font-size:2rem;text-align:center;padding:20px}

    /* Poll */
    .poll{display:flex;gap:12px;margin-top:14px}
    .poll button{flex:1;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);color:#fff;padding:10px 12px;border-radius:12px;cursor:pointer}
    .poll button:disabled{opacity:.6}
    .poll .result{font-size:12px;color:var(--muted);text-align:center;width:100%}

    /* Comments */
    .comment-area{background:#151515;padding:16px;border-top:1px solid rgba(255,255,255,.12)}
    .comment-list{display:flex;flex-direction:column;gap:10px;max-height:180px;overflow-y:auto;padding-right:6px}
    .comment{background:#222;padding:10px 14px;border-radius:10px;font-size:14px}
    .comment .author{color:var(--accent);font-weight:600}
    .comment .text{color:var(--muted)}
    .comment-form{display:flex;align-items:center;gap:10px}
    .comment-form input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:transparent;color:#fff}
    .comment-form input:focus{outline:none;border-color:var(--accent)}

    @media (max-width:600px){
      .story{min-width:90px}
      .story .avatar{width:80px;height:80px;border-radius:16px}
      .viewer-footer{flex-direction:column;align-items:flex-start}
      .viewer-footer .btn-group{width:100%;justify-content:space-between}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Buddyz — Community</h1>
      <div class="small">Stay friendly • Share memes • Celebrate friends</div>
    </header>

    <section class="stories-container">
      <h2>Recent Status</h2>
      <div class="stories" id="stories">
        <div class="story add-status" id="addStoryBtn">
          <div class="avatar"><ion-icon name="add-outline"></ion-icon></div>
          <small>Add Status</small>
        </div>
      </div>
    </section>

    <section class="feed" id="feed"></section>
  </div>

  <!-- Composer modal -->
  <div class="modal" id="modal">
    <div class="composer">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong>Create Post</strong>
        <button class="btn" id="closeComposer"><ion-icon name="close-outline"></ion-icon></button>
      </div>
      <input type="text" id="userNameInput" placeholder="Enter your name (necessary)">
      <textarea id="caption" placeholder="Say something funny..."></textarea>
      <div class="row">
        <label class="btn" id="pickImageBtn">
          <ion-icon name="image-outline"></ion-icon>
          Attach Image
          <input type="file" id="imageInput" accept="image/*">
        </label>
        <button class="btn" id="makePoll"><ion-icon name="stats-chart-outline"></ion-icon></button>
        <div style="flex:1"></div>
        <button class="btn" id="submitPost"><ion-icon name="send-outline"></ion-icon></button>
      </div>
      <div class="row" id="pollInputs" style="display:none">
        <input type="text" id="pollOption1" placeholder="Poll Option 1" />
        <input type="text" id="pollOption2" placeholder="Poll Option 2" />
      </div>
      <div class="small" id="uploaderStatus"></div>
      <div style="height:6px"></div>
      <div class="small">Tip: Posts auto-delete after 24 hours.</div>
    </div>
  </div>

  <!-- Post viewer -->
  <div class="viewer-modal" id="viewerModal">
    <div class="viewer-header">
      <div class="avatar" id="vhAvatar" style="width:44px;height:44px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:20px"></div>
      <div style="flex:1">
        <div class="name" id="vhName"></div>
        <div class="small time" id="vhTime"></div>
      </div>
      <button class="btn" id="closeViewer"><ion-icon name="close-outline"></ion-icon></button>
    </div>
    <div class="viewer-content" id="viewerContent"></div>
    <div class="viewer-footer" id="viewerFooter">
      <div class="btn-group">
        <button class="btn like-btn" id="viewerLikeBtn"><ion-icon name="heart-outline"></ion-icon></button>
        <div class="pill like-count" id="vhLikes">0</div>
      </div>
      <div class="btn-group">
        <button class="btn" id="viewerShareBtn"><ion-icon name="share-social-outline"></ion-icon></button>
        <button class="btn" id="viewerSaveBtn"><ion-icon name="download-outline"></ion-icon></button>
        <button class="btn" id="viewerReportBtn"><ion-icon name="flag-outline"></ion-icon></button>
        <button class="btn delete-btn" id="viewerDeleteBtn" title="Delete (owner only)"><ion-icon name="trash-outline"></ion-icon></button>
      </div>
    </div>
    <div class="comment-area">
      <div class="comment-list" id="commentList"></div>
      <div class="comment-form">
        <input type="text" id="commentInput" placeholder="Add a comment...">
        <button class="btn" id="sendCommentBtn"><ion-icon name="send-outline"></ion-icon></button>
      </div>
    </div>
  </div>

  <!-- Snackbar -->
  <div id="messageBox" class="message-box"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
  // ===== Firebase init =====
  const firebaseConfig = {
    apiKey: "AIzaSyAVR8OxIwbMkasKfjTVQOpi69Ikw6LraSo",
    authDomain: "buddy-ea6cd.firebaseapp.com",
    databaseURL: "https://buddy-ea6cd-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "buddy-ea6cd",
    messagingSenderId: "947901635950",
    appId: "1:947901635950:web:dd11c3a278eb18768e357f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentUser = null;
  let userProfile = null;
  const adjectives = ["Happy","Brave","Chill","Funny","Epic","Smart","Cool","Curious","Creative"];
  const nouns = ["Koala","Gamer","Wizard","Panda","Ninja","Buddy","Star","Whale","Dino"];
  function getUserProfile(uid, name){
    let profile = JSON.parse(sessionStorage.getItem('userProfile'))||{};
    if(profile.id!==uid){
      profile={id:uid,name:name||`${adjectives[Math.floor(Math.random()*adjectives.length)]} ${nouns[Math.floor(Math.random()*nouns.length)]}`,
               color:`#${Math.floor(Math.random()*16777215).toString(16).padStart(6,'0')}`};
      sessionStorage.setItem('userProfile',JSON.stringify(profile));
    }
    return profile;
  }
  firebase.auth().onAuthStateChanged(u=>{
    if(u){currentUser=u;userProfile=getUserProfile(u.uid);} else {firebase.auth().signInAnonymously().catch(console.error)}
  });

  // ===== DOM refs =====
  const storiesEl=document.getElementById('stories');
  const modal=document.getElementById('modal');
  const addStoryBtn=document.getElementById('addStoryBtn');
  const closeComposer=document.getElementById('closeComposer');
  const userNameInput=document.getElementById('userNameInput');
  const caption=document.getElementById('caption');
  const imageInput=document.getElementById('imageInput');
  const submitPost=document.getElementById('submitPost');
  const uploaderStatus=document.getElementById('uploaderStatus');
  const makePollBtn=document.getElementById('makePoll');
  const pickImageBtn=document.getElementById('pickImageBtn');
  const pollInputs=document.getElementById('pollInputs');
  const pollOption1=document.getElementById('pollOption1');
  const pollOption2=document.getElementById('pollOption2');
  const messageBox=document.getElementById('messageBox');

  const viewerModal=document.getElementById('viewerModal');
  const viewerContent=document.getElementById('viewerContent');
  const vhName=document.getElementById('vhName');
  const vhTime=document.getElementById('vhTime');
  const vhAvatar=document.getElementById('vhAvatar');
  const closeViewerBtn=document.getElementById('closeViewer');
  const viewerLikeBtn=document.getElementById('viewerLikeBtn');
  const vhLikes=document.getElementById('vhLikes');
  const viewerShareBtn=document.getElementById('viewerShareBtn');
  const viewerSaveBtn=document.getElementById('viewerSaveBtn');
  const viewerReportBtn=document.getElementById('viewerReportBtn');
  const viewerDeleteBtn=document.getElementById('viewerDeleteBtn');
  const commentList=document.getElementById('commentList');
  const commentInput=document.getElementById('commentInput');
  const sendCommentBtn=document.getElementById('sendCommentBtn');

  let selectedImageFile=null; let isPoll=false; let currentViewerPostId=null; let currentPost=null;

  // ===== Helpers =====
  function showMessage(text){messageBox.textContent=text;messageBox.classList.add('show');setTimeout(()=>messageBox.classList.remove('show'),2500)}
  function formatTime(ts){
    const d=new Date(ts); const now=Date.now(); const diff=now-ts; const min=60e3, hr=3600e3, day=86400e3;
    if(diff<min) return 'Just now'; if(diff<hr) return Math.floor(diff/min)+'m ago'; if(diff<day) return Math.floor(diff/hr)+'h ago';
    return d.toLocaleString();
  }
  function initials(name){return name.split(' ').map(w=>w[0]||'').join('').slice(0,2).toUpperCase()}

  // ===== Composer logic =====
  addStoryBtn.addEventListener('click',()=>{modal.classList.add('open');caption.value='';imageInput.value='';selectedImageFile=null;uploaderStatus.textContent='';pollInputs.style.display='none';pickImageBtn.style.display='inline-flex';makePollBtn.innerHTML='<ion-icon name="stats-chart-outline"></ion-icon>'});
  closeComposer.addEventListener('click',()=>modal.classList.remove('open'));

  imageInput.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f){selectedImageFile=null;uploaderStatus.textContent='';return}
    uploaderStatus.textContent='Processing image...';
    const reader=new FileReader(); reader.onloadend=()=>{selectedImageFile=reader.result;uploaderStatus.textContent='Image attached';isPoll=false;pollInputs.style.display='none';makePollBtn.innerHTML='<ion-icon name="stats-chart-outline"></ion-icon>';}; reader.readAsDataURL(f);
  });
  makePollBtn.addEventListener('click',()=>{isPoll=!isPoll; if(isPoll){pollInputs.style.display='flex';pickImageBtn.style.display='none';selectedImageFile=null;uploaderStatus.textContent='';makePollBtn.innerHTML='<ion-icon name="close-outline"></ion-icon>'} else {pollInputs.style.display='none';pickImageBtn.style.display='inline-flex';makePollBtn.innerHTML='<ion-icon name="stats-chart-outline"></ion-icon>'}});

  submitPost.addEventListener('click',async()=>{
    const name=userNameInput.value.trim(); const text=caption.value.trim();
    if(!name){showMessage('Please enter your name.');return}
    if(!text && !selectedImageFile && !isPoll){showMessage('Please add a caption, image, or poll.');return}
    const now=Date.now();
    const postRef=db.ref('posts').push();
    const postObj={
      id:postRef.key,
      user:{id:currentUser?currentUser.uid:'anon', name:name, color:userProfile?userProfile.color:'#888'},
      type:isPoll? 'poll': (selectedImageFile? 'image' : 'text'),
      text:text||'',
      imageData:selectedImageFile||'',
      pollOptions:isPoll? [{text:pollOption1.value||'Option A',votes:0},{text:pollOption2.value||'Option B',votes:0}] : [],
      createdAt:now,
      likeCount:0,
      commentsCount:0,
      expiresAt: now + 24*3600*1000
    };
    await postRef.set(postObj);
    modal.classList.remove('open'); showMessage('Posted!');
  });

  // ===== Render stories =====
  const posts=[]; // local cache
  db.ref('posts').orderByChild('createdAt').limitToLast(50).on('child_added',snap=>{const p=snap.val(); if(!p) return; posts.push(p); renderStories();});
  db.ref('posts').on('child_changed',snap=>{const p=snap.val(); const idx=posts.findIndex(x=>x.id===p.id); if(idx>-1){posts[idx]=p; if(currentViewerPostId===p.id){updateViewer(p)}} renderStories();});

  function renderStories(){
    // keep Add Status as first child
    const others=posts.sort((a,b)=>b.createdAt-a.createdAt).map(p=>{
      const div=document.createElement('div'); div.className='story'; div.dataset.id=p.id;
      const av=document.createElement('div'); av.className='avatar';
      if(p.type==='image' && p.imageData){ const img=document.createElement('img'); img.src=p.imageData; av.appendChild(img);} else { av.textContent=p.text? p.text.slice(0,1).toUpperCase(): initials(p.user.name)}
      const sm=document.createElement('small'); sm.textContent=p.user.name;
      div.appendChild(av); div.appendChild(sm);
      div.addEventListener('click',()=>openViewer(p.id));
      return div;
    });
    // Clear and re-append
    const keep=storiesEl.querySelector('#addStoryBtn');
    storiesEl.innerHTML=''; storiesEl.appendChild(keep);
    others.forEach(el=>storiesEl.appendChild(el));
  }

  // ===== Viewer logic =====
  function openViewer(postId){
    const p=posts.find(x=>x.id===postId); if(!p) return; currentViewerPostId=postId; currentPost=p; updateViewer(p); viewerModal.classList.add('open');
    // set like state
    const liked=localStorage.getItem('liked_'+postId)==='1';
    if(liked){viewerLikeBtn.classList.add('liked')} else {viewerLikeBtn.classList.remove('liked')}
    // load comments
    loadComments(postId);
  }

  function updateViewer(p){
    vhName.textContent=p.user.name; vhTime.textContent=formatTime(p.createdAt);
    vhAvatar.textContent=initials(p.user.name); vhAvatar.style.background=p.user.color||'#333';
    viewerContent.innerHTML='';
    if(p.type==='image' && p.imageData){ const img=new Image(); img.src=p.imageData; viewerContent.appendChild(img); }
    else if(p.type==='text'){ const div=document.createElement('div'); div.className='text-post-content'; div.textContent=p.text; viewerContent.appendChild(div); }
    else if(p.type==='poll'){ const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='stretch'; wrap.style.maxWidth='460px';
      const q=document.createElement('div'); q.className='text-post-content'; q.style.fontSize='1.4rem'; q.textContent=p.text||'Vote your choice'; wrap.appendChild(q);
      const poll=document.createElement('div'); poll.className='poll';
      const total=(p.pollOptions[0]?.votes||0)+(p.pollOptions[1]?.votes||0);
      p.pollOptions.forEach((opt,idx)=>{
        const btn=document.createElement('button'); btn.textContent=opt.text + (total? ` — ${Math.round((opt.votes/Math.max(1,total))*100)}%` : '');
        const voted=localStorage.getItem('voted_'+p.id)==='1';
        btn.disabled=voted;
        btn.addEventListener('click',async()=>{
          if(localStorage.getItem('voted_'+p.id)==='1') return;
          localStorage.setItem('voted_'+p.id,'1');
          const path=`posts/${p.id}/pollOptions/${idx}/votes`;
          await db.ref(path).transaction(v=> (v||0)+1 );
        });
        poll.appendChild(btn);
      });
      wrap.appendChild(poll); viewerContent.appendChild(wrap);
    }
    vhLikes.textContent=p.likeCount||0;
  }

  // Close viewer
  closeViewerBtn.addEventListener('click',()=>viewerModal.classList.remove('open'));
  viewerModal.addEventListener('click',e=>{ if(e.target===viewerModal) viewerModal.classList.remove('open')});
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') viewerModal.classList.remove('open')});

  // Like (one-time per post)
  viewerLikeBtn.addEventListener('click',async()=>{
    if(!currentViewerPostId) return;
    if(viewerLikeBtn.classList.contains('liked')){ showMessage('You already liked this post.'); return }
    viewerLikeBtn.classList.add('liked');
    localStorage.setItem('liked_'+currentViewerPostId,'1');
    // update UI
    const count=parseInt(vhLikes.textContent||'0',10)+1; vhLikes.textContent=count;
    // update DB
    await db.ref(`posts/${currentViewerPostId}/likeCount`).transaction(v=> (v||0)+1 );
  });

  // Comments
  function loadComments(postId){
    commentList.innerHTML='';
    db.ref(`comments/${postId}`).off();
    db.ref(`comments/${postId}`).limitToLast(100).on('child_added',snap=>{
      const c=snap.val(); if(!c) return; const row=document.createElement('div'); row.className='comment';
      row.innerHTML = `<div class="author">${c.author||'User'}</div><div class="text">${c.text||''}</div>`;
      commentList.appendChild(row); commentList.scrollTop=commentList.scrollHeight;
    });
  }
  sendCommentBtn.addEventListener('click',async()=>{
    const txt=commentInput.value.trim(); if(!txt || !currentViewerPostId) return; commentInput.value='';
    const cRef=db.ref(`comments/${currentViewerPostId}`).push();
    await cRef.set({id:cRef.key, text:txt, author:userNameInput.value.trim()||userProfile?.name||'User', ts:Date.now()});
    // bump comment count
    db.ref(`posts/${currentViewerPostId}/commentsCount`).transaction(v=> (v||0)+1);
  });

  // Share/Save/Report/Delete
  viewerShareBtn.addEventListener('click',async()=>{
    if(navigator.share && currentPost){ try{ await navigator.share({title:'Buddyz', text: currentPost.text||'', url: location.href}); } catch(e){} }
    else { showMessage('Share not supported here.'); }
  });
  viewerSaveBtn.addEventListener('click',()=>{
    if(!currentPost || !currentPost.imageData){ showMessage('Nothing to save.'); return }
    const a=document.createElement('a'); a.href=currentPost.imageData; a.download='buddyz.jpg'; document.body.appendChild(a); a.click(); a.remove();
  });
  viewerReportBtn.addEventListener('click',()=>{ showMessage('Thanks for the report. Our team will check this.'); });
  viewerDeleteBtn.addEventListener('click',async()=>{
    if(!currentPost) return; if(!currentUser || currentUser.uid!==currentPost.user.id){ showMessage('You can only delete your own post.'); return }
    await db.ref(`posts/${currentPost.id}`).remove(); showMessage('Deleted'); viewerModal.classList.remove('open');
  });

  </script>
</body>
</html>
