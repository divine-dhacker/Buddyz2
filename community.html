<!DOCTYPE html><html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Buddyz ‚Äî Community</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1113;
      --card:#121416;
      --muted:#9aa0a6;
      --accent:#ff2d2d; /* Buddyz red */
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:var(--bg);color:#eee;margin:0;min-height:100vh}
    .app{max-width:980px;margin:20px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header h1{font-size:20px;margin:0}
    /* Stories carousel */
    .stories{display:flex;overflow-x:auto;padding:8px 2px;gap:12px;margin-bottom:16px}
    .story{min-width:72px;display:flex;flex-direction:column;align-items:center;text-align:center}
    .story .avatar{width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg,#222,#111);display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.03);}
    .story small{display:block;margin-top:6px;color:var(--muted);font-size:12px}
    /* Feed */
    .feed{display:flex;flex-direction:column;gap:12px}
    .post{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}
    .post .meta{display:flex;align-items:center;gap:10px}
    .post .meta .name{font-weight:600}
    .post .content{margin-top:10px}
    .post img{max-width:100%;border-radius:8px;margin-top:8px}
    .actions{display:flex;gap:12px;margin-top:10px;align-items:center}
    .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;cursor:pointer;color:#eee}
    .like-btn.liked{color:var(--accent);font-weight:700}
    .fab{position:fixed;right:20px;bottom:20px;background:var(--accent);color:#fff;border:none;width:56px;height:56px;border-radius:50%;font-size:26px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 30px rgba(0,0,0,0.6);cursor:pointer}
    /* Composer modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.6));}
    .modal.open{display:flex}
    .composer{width:420px;background:var(--card);padding:16px;border-radius:12px}
    .composer textarea{width:100%;height:90px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#eee;padding:8px;border-radius:8px}
    .composer .row{display:flex;gap:8px;margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
    .story-indicator{border:2px solid rgba(255,255,255,0.04);padding:6px;border-radius:10px}
    /* comment area */
    .comments{margin-top:8px;border-top:1px dashed rgba(255,255,255,0.02);padding-top:8px}
    .comment{font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=file]{display:none}
    .pill{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,0.02)}
    @media(max-width:520px){.composer{width:92vw}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Buddyz ‚Äî Community</h1>
      <div class="small">Stay friendly ‚Ä¢ Share memes ‚Ä¢ Celebrate friends</div>
    </header><section class="stories" id="stories"></section>

<section class="feed" id="feed"></section>

<button class="fab" id="openComposer">+</button>

  </div>  <!-- Composer modal -->  <div class="modal" id="modal">
    <div class="composer">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Create post</strong>
        <button class="btn" id="closeComposer">Close</button>
      </div>
      <textarea id="caption" placeholder="Say something funny..."></textarea>
      <div class="row">
        <label class="btn" id="pickImageBtn">Attach Image<input type="file" id="imageInput"></label>
        <button class="btn" id="makePoll">Create Poll</button>
        <div style="flex:1"></div>
        <button class="btn" id="submitPost">Post</button>
      </div>
      <div class="small" id="uploaderStatus"></div>
      <div style="height:6px"></div>
      <div class="small">Tip: Use the shoutout function to auto-post quiz celebrations.</div>
    </div>
  </div>  <!-- Firebase SDKs (Web v8 compat for simplicity) -->  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>  <script>
    /***** REPLACE the config below with your actual Firebase project config *****/
    const firebaseConfig = {
      apiKey: "AIzaSyAVR8OxIwbMkasKfjTVQOpi69Ikw6LraSo",
  authDomain: "buddy-ea6cd.firebaseapp.com",
  databaseURL: "https://buddy-ea6cd-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "buddy-ea6cd",
  storageBucket: "buddy-ea6cd.appspot.com",
  messagingSenderId: "947901635950",
  appId: "1:947901635950:web:dd11c3a278eb18768e357f"
    };

    // initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

// Anonymous authentication
let currentUser = null;

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    currentUser = user; // we have a signed-in user
  } else {
    // sign in anonymously if no user
    firebase.auth().signInAnonymously().catch(err => {
      console.error("Auth error code:", err.code);
      console.error("Auth error message:", err.message);
    });
  }
});

    // DOM refs
    const feedEl = document.getElementById('feed');
    const storiesEl = document.getElementById('stories');
    const modal = document.getElementById('modal');
    const openComposer = document.getElementById('openComposer');
    const closeComposer = document.getElementById('closeComposer');
    const caption = document.getElementById('caption');
    const imageInput = document.getElementById('imageInput');
    const submitPost = document.getElementById('submitPost');
    const uploaderStatus = document.getElementById('uploaderStatus');

    openComposer.addEventListener('click', ()=> modal.classList.add('open'))
    closeComposer.addEventListener('click', ()=> modal.classList.remove('open'))

    // local state
    let selectedImageFile = null;
    imageInput.addEventListener('change', (e)=>{
      selectedImageFile = e.target.files[0] || null;
      uploaderStatus.textContent = selectedImageFile ? selectedImageFile.name : '';
    });

    // Create post
    submitPost.addEventListener('click', async ()=>{
      const text = caption.value.trim();
      const uid = currentUser ? currentUser.uid : 'anon';
      const post = {
        author: 'Anonymous',
        authorId: uid,
        type: selectedImageFile ? 'image' : 'text',
        caption: text || '',
        likes: 0,
        timestamp: Date.now()
      };

      // upload image if exists
      if(selectedImageFile){
        uploaderStatus.textContent = 'Uploading image...';
        const path = `posts_images/${uid}_${Date.now()}_${selectedImageFile.name}`;
        const snap = await storage.ref(path).put(selectedImageFile);
        const url = await snap.ref.getDownloadURL();
        post.content = url;
        uploaderStatus.textContent = 'Image uploaded';
      }

      // push to database
      const newRef = db.ref('posts').push();
      await newRef.set(post);

      // reset composer
      caption.value = '';
      imageInput.value = '';
      selectedImageFile = null;
      uploaderStatus.textContent = '';
      modal.classList.remove('open');
    });

    // Render helpers
    function timeAgo(ts){
      const s = Math.floor((Date.now()-ts)/1000);
      if(s<60) return s+ 's';
      const m = Math.floor(s/60); if(m<60) return m+'m';
      const h = Math.floor(m/60); if(h<24) return h+'h';
      const d = Math.floor(h/24); return d+'d';
    }

    function createPostElement(id, data){
      const el = document.createElement('div'); el.className = 'post'; el.id = 'post-'+id;
      el.innerHTML = `
        <div class="meta">
          <div class="avatar story-indicator" style="width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center">${data.author ? data.author.charAt(0).toUpperCase() : 'A'}</div>
          <div>
            <div class="name">${data.author || 'Anonymous'}</div>
            <div class="small">${timeAgo(data.timestamp)} ‚Ä¢ <span class="pill">${data.type}</span></div>
          </div>
        </div>
        <div class="content">
          ${data.caption ? '<div>'+escapeHtml(data.caption)+'</div>' : ''}
          ${data.content && data.type==='image' ? `<img src="${data.content}" alt="post image">` : ''}
        </div>
        <div class="actions">
          <button class="btn like-btn" data-id="${id}">‚ù§Ô∏è <span class="like-count">${data.likes||0}</span></button>
          <button class="btn comment-toggle" data-id="${id}">üí¨ Comment</button>
          <button class="btn share-btn" data-url>‚ÜóÔ∏è Share</button>
        </div>
        <div class="comments" style="display:none"></div>
      `;

      // like handler
      const likeBtn = el.querySelector('.like-btn');
      likeBtn.addEventListener('click', ()=> toggleLike(id, likeBtn));

      // comment toggle
      const commentToggle = el.querySelector('.comment-toggle');
      const commentsEl = el.querySelector('.comments');
      commentToggle.addEventListener('click', ()=>{
        if(commentsEl.style.display==='none'){
          commentsEl.style.display='block';
          loadComments(id, commentsEl);
        } else commentsEl.style.display='none';
      });

      // share
      const shareBtn = el.querySelector('.share-btn');
      shareBtn.addEventListener('click', ()=>{
        const u = window.location.href + '#post-' + id;
        if(navigator.share){
          navigator.share({title:'Buddyz post', text: data.caption || 'Check this out', url: u}).catch(()=>{});
        } else { navigator.clipboard.writeText(u).then(()=> alert('Post link copied')) }
      });

      return el;
    }

    // escape helper
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // Toggle like using transaction (safe in realtime db)
    function toggleLike(postId, btn){
      const likesRef = db.ref(`posts/${postId}/likes`);
      likesRef.transaction(current=>{ return (current||0) + 1; }, (err, committed, snap)=>{
        if(err) return console.error(err);
        if(committed){
          btn.classList.add('liked');
          btn.querySelector('.like-count').textContent = snap.val();
        }
      });
    }

    // Comments: load and add form
    async function loadComments(postId, container){
      container.innerHTML = '<div class="small">Loading comments...</div>';
      const snap = await db.ref(`posts/${postId}/comments`).once('value');
      const obj = snap.val() || {};
      container.innerHTML = '';
      const form = document.createElement('div');
      form.innerHTML = `<input placeholder="Add a comment" style="width:70%" id="cinput-${postId}"> <button class="btn" id="cbtn-${postId}">Send</button>`;
      container.appendChild(form);
      document.getElementById(`cbtn-${postId}`).addEventListener('click', ()=>{
        const v = document.getElementById(`cinput-${postId}`).value.trim();
        if(!v) return;
        const cRef = db.ref(`posts/${postId}/comments`).push();
        cRef.set({author:'Anonymous',text:v,timestamp:Date.now()});
        document.getElementById(`cinput-${postId}`).value='';
        loadComments(postId, container); // reload
      });

      // show existing
      const keys = Object.keys(obj).sort((a,b)=> (obj[a].timestamp||0)-(obj[b].timestamp||0));
      keys.forEach(k=>{
        const c = obj[k];
        const div = document.createElement('div'); div.className='comment';
        div.textContent = (c.author||'Anonymous') + ': ' + (c.text||'');
        container.appendChild(div);
      });
    }

    // Live feed: listen for posts
    const postsRef = db.ref('posts').limitToLast(100);
    postsRef.on('child_added', snap=>{
      const id = snap.key; const data = snap.val();
      // Prepend to top
      const el = createPostElement(id, data);
      feedEl.insertBefore(el, feedEl.firstChild);
      updateStories();
    });

    postsRef.on('child_changed', snap=>{
      const id = snap.key; const data = snap.val();
      const existing = document.getElementById('post-'+id);
      if(existing){
        const newEl = createPostElement(id,data);
        feedEl.replaceChild(newEl, existing);
      }
    });

    postsRef.on('child_removed', snap=>{
      const id = snap.key; const el = document.getElementById('post-'+id); if(el) el.remove();
      updateStories();
    });

    // Stories derived from last 20 posts (unique authors)
    async function updateStories(){
      const snap = await db.ref('posts').orderByChild('timestamp').limitToLast(40).once('value');
      const obj = snap.val() || {};
      const authors = {};
      Object.keys(obj).reverse().forEach(k=>{ const p=obj[k]; if(!authors[p.authorId]) authors[p.authorId]=p; });
      storiesEl.innerHTML='';
      Object.keys(authors).forEach(aId=>{
        const p = authors[aId];
        const s = document.createElement('div'); s.className='story';
        s.innerHTML = `<div class="avatar">${(p.author||'A').charAt(0).toUpperCase()}</div><small>${p.author||'Anon'}</small>`;
        storiesEl.appendChild(s);
      });
    }

    // Utility: create a shoutout post (call this from quiz result code when someone aces a quiz)
    async function createShoutout(name, message){
      const post = {
        author: name || 'System',
        authorId: 'system',
        type: 'shoutout',
        caption: message || `üéâ Congrats to ${name} for acing the quiz!`,
        likes: 0,
        timestamp: Date.now()
      };
      await db.ref('posts').push().set(post);
    }

    // Expose shoutout to global so quiz logic can call it
    window.createShoutout = createShoutout;

    // Example: if you want to auto-create a shoutout for testing, uncomment:
    // setTimeout(()=> createShoutout('Alex','Alex just scored 15/15 on Buddyz!'), 2000);

    // Initial load of stories as empty
    updateStories();
  </script></body>
</html>